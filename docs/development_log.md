# NDL歴史資料横断検索チャットアプリ 開発記録 (Development Log)

このドキュメントは、本プロジェクトの開発工程、技術仕様、設計思想、および今後の課題をまとめたものです。将来的な機能拡張やメンテナンスの際の引き継ぎ資料として活用してください。

---

## 1. 開発工程の概略

本プロジェクトは以下のステップを経て開発されました。

1.  **環境構築 & リサーチ**:
    - Next.js (App Router) + Tailwind CSS をベースに選定。
    - 国立国会図書館 (NDL) の API (OpenSearch, Lab Page API, IIIF) の仕様を確認し、歴史資料の検索・抽出が可能であることを検証。
2.  **NDL API 連携ロジックの実装 (`src/lib/ndl-api.ts`)**:
    - 資料検索、スニペット（抜粋）の取得、ランダム検索機能を実装。
    - OCRの誤字脱字や不要なタグをクレンジングする処理を追加。
3.  **Gemini AI 連携の実装 (`src/app/api/chat/route.ts`)**:
    - ユーザーの曖昧な問いを歴史的語彙（旧国名、妖怪の別称など）に能動的に広げる「知識拡張プロンプト」を設計。
    - NDLから得た資料断片を基に、古風な「歴史案内人」の口調で回答を生成。
4.  **UI/UX の高度化**:
    - **会話管理**: 複数スレッド、タイトル編集、削除確認を実装。
    - **探索支援**: 文中の語句にホバーすると出典が表示される「インライン引用」、全会話からの「全文検索」、検索結果への「スクロールジャンプ」を実装。
5.  **ビジュアルの試行錯誤**:
    - 当初は明るい和風デザインを採用。一時期「藍摺絵（ダークIndigo）」テーマへの刷新（浮世絵切り抜き背景、人魂形状UI）を行ったが、最終的に視認性を重視して明るい和紙テーマへ復元し、機能を洗練させた。

---

## 2. 技術仕様・API定義

### 2.1 NDL API
- **NDL検索API (OpenSearch)**: タイトルやキーワードによる資料検索。主に `pid` (永続的識別子) の取得に使用。
- **NDL Lab Page API**: `pid` を指定して、資料内のテキスト（OCR結果）をページ単位で取得。
  - `highlights` パラメータを使用して、キーワードに合致する箇所の抽出を最適化。
- **IIIF (Image Interoperability Framework)**: 背景装飾などで資料の一部を切り抜く際に活用（画像配信API）。

### 2.2 Gemini API (Google Generative AI)
- **Model**: `gemini-1.5-flash-latest` を使用。
- **Role**:
  - **Query Generator**: 検索クエリの最適化と知識拡張。
  - **Summarizer**: 資料を読み解き、キャラクター性（歴史案内人）を持たせた回答生成。
  - **Citer**: 回答内の重要語句を `<cite id="N">...</cite>` タグで囲み、フロントエンドでのポップアップ表示を可能にする。

### 2.3 フロントエンド・永続化
- **State Management**: React `useState`, `useMemo` によるリアクティブなUI。
- **Persistence**: `localStorage` を使用し、会話履歴、スレッド名、メッセージIDをすべてブラウザに保存。

---

## 3. UI/UX 設計思想

- **和風モダンと歴史体験**: 「資料を調べる」という行為を「物語を紐解く」体験に変えるため、和紙の質感や「さわらび明朝」フォント、落ち着いた色合いを採用。
- **エビデンスの可視化**: AIの創作（ハルシネーション）を防ぐため、すべての重要語句に「出典」を紐付け、ホバー一つで原文を確認できるインターフェースを徹底。
- **直感的な操作**: サイドバーでの履歴管理、スプレッドシートやドキュメントのような全文検索ジャンプなど、モダンなチャットツールと同等の利便性を和風UIに統合。

---

## 4. 現在の課題と今後の展望

### 4.1 技術的な課題
- **OCR 精度への依存**: 元資料が古いため、OCR（文字認識）の誤りによりAIが文脈を誤読する場合がある。より高度なクレンジング、あるいはAI側での補正プロンプトの強化が必要。
- **APIレート制限**: Gemini API や NDL API の負荷状況により、回答が遅延したりエラー (503) が出たりすることがある（現在はリトライ処理で暫定対応）。

### 4.2 今後の機能拡張案
- **画像プレビューの強化**: ポップアップ内に資料の原本画像（IIIF）を表示する。
- **資料の「お気に入り」機能**: 出典スニペットを個別に保存し、後で一覧できるスクラップブック機能。
- **PDF/テキスト出力**: 調べた内容を「調査報告書」として和風のPDF形式で書き出す機能。
- **SNS 共有**: 興味深い歴史の謎を、出典付きで画像化して共有する機能。

---

## 5. 実行方法

1. `.env.local` に `GEMINI_API_KEY` を設定。
2. `npm install` で依存関係を導入。
3. `npm run dev` で起動し、[http://localhost:3000](http://localhost:3000) へアクセス。

---
**開発者**: Antigravity (Powered by Google DeepMind)
**最終更新**: 2026年2月16日
